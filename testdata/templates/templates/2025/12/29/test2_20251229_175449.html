<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务进度报告</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', 'SimSun', Arial, sans-serif;
            font-size: 12pt;
            line-height: 1.6;
            margin: 40px;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        h2 {
            color: #34495e;
            border-left: 4px solid #3498db;
            padding-left: 10px;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        h3 {
            color: #555;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .info-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .info-item {
            margin: 5px 0;
        }
        .overview {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 11pt;
        }
        table th {
            background-color: #3498db;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        table tr:hover {
            background-color: #e8f4f8;
        }
        .task-list {
            margin: 15px 0;
            padding-left: 20px;
        }
        .task-item {
            margin: 8px 0;
            padding: 8px;
            background-color: #fff;
            border-left: 3px solid #3498db;
        }
        .assignee-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #777;
            font-size: 10pt;
        }
    </style>
</head>
<body>
    {# 在模板中使用Jinja2处理CSV数据，直接从tables['data']转换 #}
    {% set tasks_data = tables.get('data', []) %}
    {% set project_name = title or '项目名称' %}
    {% set report_date = now.strftime('%Y-%m-%d') %}
    {% set project_manager = '项目经理' %}
    
    <h1>任务进度报告</h1>
    
    <div class="info-section">
        <div class="info-item"><strong>项目名称：</strong>{{ project_name }}</div>
        <div class="info-item"><strong>报告日期：</strong>{{ report_date }}</div>
        <div class="info-item"><strong>项目经理：</strong>{{ project_manager }}</div>
    </div>
    
    <h2>一、任务概览</h2>
    <div class="overview">
        {% set total_count = tasks_data|length %}
        {% set counters = namespace(completed=0, in_progress=0, not_started=0) %}
        {% for task in tasks_data %}
            {% set status = (task.get('Status', task.get('status', ''))|string).lower() %}
            {% if 'completed' in status or '完成' in status %}
                {% set counters.completed = counters.completed + 1 %}
            {% elif 'in progress' in status or '进行' in status or '进行中' in status %}
                {% set counters.in_progress = counters.in_progress + 1 %}
            {% elif 'not started' in status or '未开始' in status %}
                {% set counters.not_started = counters.not_started + 1 %}
            {% endif %}
        {% endfor %}
        任务总数：{{ total_count }} | 已完成：{{ counters.completed }} | 进行中：{{ counters.in_progress }} | 未开始：{{ counters.not_started }}
    </div>
    
    <h2>二、任务详细列表</h2>
    {{table:data}}
    
    <h2>三、按状态分类</h2>
    
    <h3>3.1 已完成任务</h3>
    {% set completed_tasks = [] %}
    {% for task in tasks_data %}
        {% set status = (task.get('Status', task.get('status', ''))|string).lower() %}
        {% if 'completed' in status or '完成' in status %}
            {% set _ = completed_tasks.append(task) %}
        {% endif %}
    {% endfor %}
    {% if completed_tasks|length > 0 %}
    <div class="task-list">
        {% for task in completed_tasks %}
            <div class="task-item">
                <strong>{{ task.get('Task ID', task.get('task_id', '')) }}</strong> - {{ task.get('Task Name', task.get('task_name', '')) }}（负责人：{{ task.get('Assignee', task.get('assignee', '')) }}，完成日期：{{ task.get('Due Date', task.get('due_date', '')) }}）
            </div>
        {% endfor %}
    </div>
    {% else %}
    <p>暂无已完成任务</p>
    {% endif %}
    
    <h3>3.2 进行中任务</h3>
    {% set in_progress_tasks = [] %}
    {% for task in tasks_data %}
        {% set status = (task.get('Status', task.get('status', ''))|string).lower() %}
        {% if 'in progress' in status or '进行' in status or '进行中' in status %}
            {% set _ = in_progress_tasks.append(task) %}
        {% endif %}
    {% endfor %}
    {% if in_progress_tasks|length > 0 %}
    <div class="task-list">
        {% for task in in_progress_tasks %}
            <div class="task-item">
                <strong>{{ task.get('Task ID', task.get('task_id', '')) }}</strong> - {{ task.get('Task Name', task.get('task_name', '')) }}（负责人：{{ task.get('Assignee', task.get('assignee', '')) }}，截止日期：{{ task.get('Due Date', task.get('due_date', '')) }}，优先级：{{ task.get('Priority', task.get('priority', '')) }}）
            </div>
        {% endfor %}
    </div>
    {% else %}
    <p>暂无进行中任务</p>
    {% endif %}
    
    <h3>3.3 未开始任务</h3>
    {% set not_started_tasks = [] %}
    {% for task in tasks_data %}
        {% set status = (task.get('Status', task.get('status', ''))|string).lower() %}
        {% if 'not started' in status or '未开始' in status %}
            {% set _ = not_started_tasks.append(task) %}
        {% endif %}
    {% endfor %}
    {% if not_started_tasks|length > 0 %}
    <div class="task-list">
        {% for task in not_started_tasks %}
            <div class="task-item">
                <strong>{{ task.get('Task ID', task.get('task_id', '')) }}</strong> - {{ task.get('Task Name', task.get('task_name', '')) }}（负责人：{{ task.get('Assignee', task.get('assignee', '')) }}，截止日期：{{ task.get('Due Date', task.get('due_date', '')) }}，优先级：{{ task.get('Priority', task.get('priority', '')) }}）
            </div>
        {% endfor %}
    </div>
    {% else %}
    <p>暂无未开始任务</p>
    {% endif %}
    
    <h2>四、按负责人分组</h2>
    {# 收集所有负责人 #}
    {% set assignees = namespace(list=[]) %}
    {% for task in tasks_data %}
        {% set assignee = task.get('Assignee', task.get('assignee', '')) %}
        {% if assignee and assignee not in assignees.list %}
            {% set _ = assignees.list.append(assignee) %}
        {% endif %}
    {% endfor %}
    {% for assignee in assignees.list %}
    <div class="assignee-section">
        <h3>{{ assignee }}</h3>
        <div class="task-list">
            {% for task in tasks_data %}
                {% if task.get('Assignee', task.get('assignee', '')) == assignee %}
                <div class="task-item">
                    {{ task.get('Task Name', task.get('task_name', '')) }}（{{ task.get('Status', task.get('status', '')) }}，截止日期：{{ task.get('Due Date', task.get('due_date', '')) }}，优先级：{{ task.get('Priority', task.get('priority', '')) }}）
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}
    
    <div class="footer">
        <p>报告生成时间：{{ report_date }}</p>
    </div>
</body>
</html>
