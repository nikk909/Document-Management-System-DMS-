# 推荐模板功能说明

## 功能概述

系统在文档生成页面提供**自动推荐模板**功能，当用户选择数据文件后，系统会根据文件名自动匹配并推荐合适的模板。

## 实现原理

### 1. 触发时机

推荐模板功能在以下情况下触发：
- 用户上传新的数据文件
- 用户从文件列表选择已有数据文件

### 2. 匹配算法

系统使用**文件名匹配**算法来推荐模板：

```
数据文件名: test4.json
模板名称: test4

匹配逻辑: 数据文件名（去除扩展名）包含模板名，或模板名包含数据文件名
```

**匹配规则**：
1. **完全匹配（优先级最高）**: 数据文件名 == 模板名 → 匹配分数 1.0
2. **部分匹配**: 数据文件名 包含 模板名 或 模板名 包含 数据文件名 → 匹配分数 0.8
3. **无匹配**: 返回所有模板按分类分组 → 匹配分数 0.5

### 3. 代码实现

后端 API: `GET /api/documents/recommend`

```python
@app.get("/api/documents/recommend")
async def recommend_document_generation(
    data_filename: Optional[str] = Query(None),
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # 1. 获取所有最新模板
    templates = db.query(TemplateMetadata).filter(
        TemplateMetadata.is_latest == True
    ).all()
    
    # 2. 从数据文件名提取基础名
    data_name = Path(data_filename).stem.lower()  # test4.json → test4
    
    # 3. 按模板名称分组并匹配
    for tpl_name, tpl_list in template_groups.items():
        if data_name in tpl_name or tpl_name in data_name:
            # 匹配成功，添加到推荐列表
            ...
    
    # 4. 返回推荐结果（按匹配分数排序）
    return {"recommendations": recommendations[:10]}
```

前端调用:

```javascript
async function recommendTemplates(dataFilename) {
    const response = await fetch(
        `${API_BASE_URL}/api/documents/recommend?data_filename=${encodeURIComponent(dataFilename)}`,
        { headers: getAuthHeaders() }
    );
    
    if (response.ok) {
        const data = await response.json();
        if (data.recommendations.length > 0) {
            // 自动选择第一个推荐的模板
            select.value = data.recommendations[0].template_id;
            // 显示推荐提示
            ...
        }
    }
}
```

## 推荐结果展示

当有匹配的模板时，系统会在模板选择下拉框上方显示推荐信息：

```
💡 自动推荐模板：test1
数据文件名 'test1.json' 与模板 'test1' 匹配
可用格式：WORD, HTML
```

## 模板命名建议

为了获得最佳的推荐效果，建议：

1. **数据文件和模板使用相同的基础名称**
   - 数据文件: `员工报表.json`
   - Word模板: `员工报表.docx`
   - HTML模板: `员工报表.html`

2. **按业务类型命名**
   - `财务报表.json` ↔ `财务报表.docx`
   - `月度销售.csv` ↔ `月度销售.html`

3. **避免过于通用的名称**
   - ❌ `data.json`, `template.docx`
   - ✅ `2024年度销售报表.json`, `2024年度销售报表.docx`

## 多格式模板支持

一个模板名可以有多种格式的模板：

| 模板名 | Word模板 | HTML模板 | 说明 |
|--------|----------|----------|------|
| test1 | test1.docx | test1.html | 推荐时显示"可用格式：WORD, HTML" |
| test4 | test4.docx | test4.html | 根据输出格式自动选择对应模板 |

**输出格式与模板格式对应关系**：
- **Word输出** → 使用Word模板(.docx)
- **HTML输出** → 使用HTML模板(.html)
- **PDF输出** → 使用HTML模板(.html)，通过WeasyPrint转换为PDF

## 注意事项

1. **模板版本**: 推荐功能只匹配 `is_latest=True` 的最新版本模板
2. **大小写不敏感**: 文件名匹配不区分大小写
3. **分类无关**: 推荐算法基于文件名，不考虑模板分类
4. **静默失败**: 如果推荐失败，不会显示错误，用户可手动选择

---

*文档版本: 1.0*
*最后更新: 2025-12-31*

