# 模板格式说明文档

本文档说明系统支持的Jinja2模板格式，以及在Word和HTML模板中的使用方法。

## 目录

1. [基础语法](#1-基础语法)
2. [HTML模板](#2-html模板)
3. [Word模板](#3-word模板)
4. [数据结构](#4-数据结构)
5. [内置变量](#5-内置变量)
6. [常用示例](#6-常用示例)

---

## 1. 基础语法

### 1.1 变量输出

使用双花括号输出变量值：

```jinja2
{{ variable_name }}
{{ document.title }}
{{ table_data[0].姓名 }}
```

### 1.2 条件语句

```jinja2
{% if condition %}
    显示内容
{% elif another_condition %}
    其他内容
{% else %}
    默认内容
{% endif %}
```

### 1.3 循环语句

```jinja2
{% for item in items %}
    {{ item.name }}: {{ item.value }}
{% endfor %}

{% for key, value in dict.items() %}
    {{ key }}: {{ value }}
{% endfor %}
```

### 1.4 过滤器

```jinja2
{{ name | upper }}              {# 转大写 #}
{{ name | lower }}              {# 转小写 #}
{{ price | round(2) }}          {# 四舍五入 #}
{{ list | length }}             {# 获取长度 #}
{{ text | default('默认值') }}  {# 默认值 #}
```

---

## 2. HTML模板

### 2.1 基本结构

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ document.title }}</title>
    <style>
        /* 自定义样式 */
    </style>
</head>
<body>
    <h1>{{ title }}</h1>
    
    {% if content %}
    <p>{{ content }}</p>
    {% endif %}
    
    <!-- 表格数据 -->
    {% if table_data %}
    <table>
        <thead>
            <tr>
                {% for key in table_data[0].keys() %}
                <th>{{ key }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in table_data %}
            <tr>
                {% for value in row.values() %}
                <td>{{ value }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</body>
</html>
```

### 2.2 表格占位符

系统支持特殊的表格占位符语法：

```html
{{table:table_name}}
```

这会自动将 `table_name` 对应的表格数据渲染为HTML表格。

### 2.3 图表占位符

```html
{{chart:chart_name}}
```

这会自动生成图表的Canvas元素和渲染脚本。

### 2.4 图片占位符

```html
{{image:image_name}}
```

支持从数据中读取图片（Base64或URL）并插入到文档中。

---

## 3. Word模板

Word模板使用 `.docx` 格式，通过 python-docx-template 库渲染。

### 3.1 文本占位符

在Word文档中直接使用Jinja2语法：

```
标题: {{ document.title }}
日期: {{ document.date }}
部门: {{ document.department }}
```

### 3.2 表格处理

**方法1：使用表格占位符**

在Word文档中创建表格，在需要循环的行中使用：

| 姓名 | 部门 | 职位 |
|------|------|------|
| {% for row in table_data %}{{ row.姓名 }} | {{ row.部门 }} | {{ row.职位 }}{% endfor %} |

**方法2：使用特殊占位符**

```
{{table:data}}
```

系统会自动将数据渲染为表格。

### 3.3 图片插入

```
{{image:logo}}
```

支持指定图片尺寸：

```
{{image:logo|width=200|height=100}}
```

### 3.4 条件内容

```
{% if show_salary %}
薪资信息: {{ salary }}
{% endif %}
```

---

## 4. 数据结构

### 4.1 JSON数据格式

```json
{
  "document": {
    "title": "文档标题",
    "date": "2024-12-29",
    "department": "部门名称"
  },
  "title": "主标题",
  "content": "文档内容描述",
  "table_data": [
    {
      "姓名": "张三",
      "部门": "技术部",
      "薪资": 15000
    },
    {
      "姓名": "李四",
      "部门": "销售部",
      "薪资": 12000
    }
  ],
  "chart_data": {
    "type": "bar",
    "title": "部门人数统计",
    "labels": ["技术部", "销售部", "市场部"],
    "series": [
      {
        "name": "人数",
        "points": [15, 12, 8]
      }
    ]
  },
  "images": []
}
```

### 4.2 CSV数据格式

CSV文件会自动转换为 `table_data` 格式：

```csv
姓名,部门,职位,薪资
张三,技术部,工程师,15000
李四,销售部,经理,12000
```

转换后可通过 `table_data` 访问：

```jinja2
{% for row in table_data %}
{{ row.姓名 }} - {{ row.部门 }}
{% endfor %}
```

---

## 5. 内置变量

系统自动提供以下变量：

| 变量名 | 说明 | 示例 |
|--------|------|------|
| `now` | 当前时间 | `{{ now.strftime('%Y-%m-%d') }}` |
| `datetime` | datetime类 | `{{ datetime.now() }}` |
| `title` | 文档标题 | `{{ title }}` |
| `content` | 文档内容 | `{{ content }}` |
| `tables` | 所有表格数据 | `{{ tables.data }}` |
| `charts` | 所有图表数据 | `{{ charts.chart1 }}` |
| `images` | 所有图片数据 | `{{ images.logo }}` |
| `document` | 文档元数据 | `{{ document.date }}` |
| `table_data` | 表格数据列表 | `{% for row in table_data %}` |
| `chart_data` | 图表配置 | `{{ chart_data.type }}` |

---

## 6. 常用示例

### 6.1 显示当前日期

```jinja2
生成日期: {{ now.strftime('%Y年%m月%d日') }}
生成时间: {{ now.strftime('%Y-%m-%d %H:%M:%S') }}
```

### 6.2 遍历表格数据

```jinja2
{% for employee in table_data %}
员工: {{ employee.姓名 }}
部门: {{ employee.部门 }}
薪资: {{ employee.薪资 | default('保密') }}
---
{% endfor %}
```

### 6.3 条件显示

```jinja2
{% if employee.薪资 > 10000 %}
高薪员工
{% else %}
普通员工
{% endif %}
```

### 6.4 带索引的循环

```jinja2
{% for row in table_data %}
{{ loop.index }}. {{ row.姓名 }}
{% endfor %}
```

### 6.5 处理空值

```jinja2
{{ value | default('无数据') }}
{{ value if value else '未填写' }}
```

### 6.6 字符串处理

```jinja2
{{ name | upper }}                 {# 转大写 #}
{{ name | lower }}                 {# 转小写 #}
{{ name | capitalize }}            {# 首字母大写 #}
{{ name | title }}                 {# 每个单词首字母大写 #}
{{ text | truncate(50) }}          {# 截断并添加... #}
{{ text | replace('old', 'new') }} {# 替换 #}
```

### 6.7 数字格式化

```jinja2
{{ price | round(2) }}             {# 保留2位小数 #}
{{ count | int }}                  {# 转整数 #}
{{ amount | float }}               {# 转浮点数 #}
```

### 6.8 列表操作

```jinja2
{{ items | length }}               {# 列表长度 #}
{{ items | first }}                {# 第一个元素 #}
{{ items | last }}                 {# 最后一个元素 #}
{{ items | join(', ') }}           {# 用逗号连接 #}
{{ items | sort }}                 {# 排序 #}
{{ items | reverse | list }}       {# 反转 #}
```

---

## 7. 敏感数据脱敏

系统支持自动脱敏以下类型的数据：

- **身份证号**: `110101********1234`
- **手机号**: `138****5678`
- **邮箱**: `zha***@company.com`
- **银行卡号**: `6222********0123`
- **姓名**: `张*` 或 `张**`

在生成文档时勾选"脱敏"选项即可自动处理。

---

## 8. 注意事项

1. **编码问题**: 模板文件和数据文件都应使用 UTF-8 编码
2. **变量名**: 避免使用中文变量名，建议使用英文或拼音
3. **空值处理**: 始终为可能为空的变量提供默认值
4. **循环嵌套**: 避免过深的循环嵌套，影响渲染性能
5. **大数据量**: 超过1000行的表格建议分页处理

---

## 9. 文件对应关系

| 数据格式 | 推荐模板位置 | 说明 |
|----------|--------------|------|
| CSV | `testdata/csv/` | CSV数据自动转为table_data |
| JSON | `testdata/json/` | JSON数据直接使用 |

---

*文档版本: 1.0*
*最后更新: 2025-12-31*

