# 功能指南

## 1. 模板管理

### 多格式支持
上传 `.docx`、`.html` 或 `.pdf`（内部按 HTML 处理）格式的模板。

### 版本控制
- **自动递增**: 每次上传同名模板时自动递增版本号。
- **回滚功能**: 一键回滚到任意历史版本。
- **跨格式关联**: 同名模板在不同格式间关联（例如，名为 "发票" 的 Word 模板和 HTML 模板）。

**实现状态**: ⚠️ 后端已完全支持版本历史（MinIO 版本控制 + MySQL 元数据），但前端 UI 界面尚未完成（缺少版本列表展示和回滚按钮）。

## 2. 文档生成

### 数据源
- **JSON**: 支持嵌套结构和数组。
- **CSV**: 自动表格检测和图表生成。

### 动态元素
- **表格**: 自动将数据列表渲染为格式化的表格。
- **图表**: 从数值 CSV 数据自动生成折线图和柱状图。
- **图片**: 使用 base64、MinIO ID 或 URL 插入图片。

### 安全选项
- **数据脱敏**: ✅ **已完全实现**
  - 自动识别并脱敏敏感字段：身份证号、手机号、邮箱、银行卡、姓名等
  - 脱敏规则：
    - 身份证: `110101199001011234` → `XXX01199001011XXXX`
    - 手机号: `13812345678` → `138****5678`
    - 邮箱: `user@example.com` → `u***@example.com`
  - 无需手动配置：后端 `DataMasker` 模块自动检测和脱敏，无需前端手动选择字段
  - 支持递归处理：嵌套字典和列表的递归脱敏

- **水印功能**: ✅ **已完全实现**
  - **文字水印**: 可自定义文字，默认 45 度角
    - Word: VML 背景水印（半透明，不干扰文本）
    - PDF: ReportLab 生成水印层
    - HTML: CSS 背景水印
  - **图片水印**: 从图片库中选择背景图片
    - 支持从 MinIO 图片库选择水印图片
    - 自动调整大小和透明度

- **加密保护**: ✅ **已完全实现**
  - **PDF**: 使用 PyPDF2 实现密码保护
  - **Word**: 使用 XML 文档保护设置只读模式

## 3. 访问控制（黑名单）

### 配置
管理员可以为单个生成的文档设置黑名单，禁止特定用户或部门访问。

### 执行
- **下载检查**: 防止未授权下载，显示"您无权下载"消息。
- **删除检查**: 防止未授权删除。
- **UI 可见性**: 被阻止的用户看不到受限操作。

## 4. 示例

### Jinja2 示例（Word/HTML）
```jinja2
你好 {{ name }}，
您 {{ month }} 的销售数据：
{{ table:sales_data }}
```

### 自动脱敏示例
输入: `110101199001011234`
输出: `XXX01199001011XXXX`

## 5. 架构说明

### 元数据处理与实际文本处理的分离
系统的元数据处理和实际文本处理是分离的：
- **元数据处理**: 在 MySQL 数据库中存储文件信息（ID、名称、路径、分类、权限等）。
- **实际文本处理**: 在 MinIO 对象存储中保存实际文件内容。
- **优势**: 
  - 提高查询效率（元数据查询快速）
  - 支持大文件存储（MinIO 可扩展到 PB 级）
  - 灵活的分类和权限管理（通过数据库元数据）

