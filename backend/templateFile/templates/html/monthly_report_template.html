<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ document.title if document else '月度报表' }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 40px; 
            color: #333; 
            background-color: #f4f4f4; 
        }
        .container { 
            max-width: 800px; 
            margin: auto; 
            background: #fff; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: #0056b3; 
            text-align: center; 
            margin-bottom: 10px; 
        }
        h2 { 
            color: #0056b3; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 5px; 
            margin-top: 30px; 
        }
        p { 
            line-height: 1.6; 
        }
        .date { 
            text-align: center; 
            color: #666; 
            margin-bottom: 30px; 
        }
        .table-responsive { 
            overflow-x: auto; 
            margin-top: 20px; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 10px; 
            text-align: left; 
        }
        th { 
            background-color: #f2f2f2; 
            font-weight: bold; 
        }
        .chart-container { 
            width: 100%; 
            height: 400px; 
            margin-top: 30px; 
            background: #f9f9f9; 
            padding: 15px; 
            border-radius: 5px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }
        .image-container { 
            text-align: right; 
            margin-top: 40px; 
        }
        .image-container img { 
            max-width: 200px; 
            height: auto; 
            border: 1px solid #ddd; 
            padding: 5px; 
            background: #fff; 
            margin-left: 10px; 
        }
        .dynamic-image {
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ document.title if document else '月度报表' }}</h1>
        {% if document and document.date %}
        <p class="date">报告日期：{{ document.date }}</p>
        {% endif %}

        {% if table_data %}
        <h2>部门销售汇总</h2>
        <div class="table-responsive">
            {{ process_table_with_merge(table_data, table_merge) | safe }}
        </div>
        {% endif %}

        {% if chart_data %}
        <h2>{{ chart_data.title }}</h2>
        <div class="chart-container">
            <canvas id="myChart" data-chart='{{ chart_data | tojson }}'></canvas>
        </div>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            var ctxEl = document.getElementById('myChart');
            if (ctxEl) {
                var chartDataStr = ctxEl.getAttribute('data-chart');
                if (chartDataStr) {
                    var chartData = JSON.parse(chartDataStr);
                    var ctx = ctxEl.getContext('2d');
                    var chartConfig = {
                        type: chartData.type || 'line',
                        data: {
                            labels: chartData.labels || [],
                            datasets: (chartData.series || []).map(function(s) {
                                return {
                                    label: s.name || '数据',
                                    data: s.points || s.data || [],
                                    borderColor: 'rgb(75, 192, 192)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    tension: 0.1,
                                    fill: false
                                };
                            })
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: chartData.title || '图表'
                                },
                                legend: {
                                    display: true
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: chartData.x_label || 'X轴'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: chartData.y_label || 'Y轴'
                                    }
                                }
                            }
                        }
                    };
                    new Chart(ctx, chartConfig);
                }
            }
        });
        </script>
        {% endif %}

        {% if images %}
        <div class="image-container">
            {% for image in images %}
                {% set img_src = process_image_src(image.src) %}
                {% set img_width = image.width if image.width else 200 %}
                {% set img_height = image.height if image.height else 0 %}
                {% set img_alt = image.alt if image.alt else '图片' %}
                <img class="dynamic-image" 
                     src="{{ img_src }}" 
                     alt="{{ img_alt }}" 
                     data-width="{{ img_width }}"
                     {% if img_height > 0 %}data-height="{{ img_height }}"{% endif %}>
            {% endfor %}
        </div>
        <script>
        (function() {
            var images = document.querySelectorAll('.dynamic-image');
            images.forEach(function(img) {
                var width = img.getAttribute('data-width');
                var height = img.getAttribute('data-height');
                if (width) {
                    img.style.width = width + 'px';
                }
                if (height) {
                    img.style.height = height + 'px';
                }
            });
        })();
        </script>
        {% endif %}
    </div>
</body>
</html>